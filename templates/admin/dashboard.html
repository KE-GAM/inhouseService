{% extends "sidebar_base.html" %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">ğŸ“Š ê´€ë¦¬ì ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</h2>
      <p class="text-muted">5ê°œ ì¸í•˜ìš°ìŠ¤ ì„œë¹„ìŠ¤ì˜ í•µì‹¬ ì§€í‘œë¥¼ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤</p>
    </div>
    <div class="text-muted">
      <small id="lastUpdated"></small>
    </div>
  </div>

  <!-- ìƒë‹¨ ì»¨íŠ¸ë¡¤ ë°” -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-2">
          <label for="serviceSelect" class="form-label">ì„œë¹„ìŠ¤ ì„ íƒ</label>
          <select class="form-select" id="serviceSelect">
            <option value="booker">Desk & Room Booker</option>
            <option value="calendar">Calendar HUB</option>
            <option value="reportit">Report-It</option>
            <option value="faq">Nota Guidebook</option>
            <option value="noonpick">NoonPick</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="fromDate" class="form-label">ì‹œì‘ì¼ì‹œ</label>
          <input type="datetime-local" class="form-control" id="fromDate">
        </div>
        <div class="col-md-3">
          <label for="toDate" class="form-label">ì¢…ë£Œì¼ì‹œ</label>
          <input type="datetime-local" class="form-control" id="toDate">
        </div>
        <div class="col-md-2">
          <label for="bucketType" class="form-label">ë²„í‚· íƒ€ì…</label>
          <select class="form-select" id="bucketType">
            <option value="auto">ìë™ íŒì •</option>
            <option value="hour">ì‹œê°„ë³„</option>
            <option value="day">ì¼ë³„</option>
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100" id="loadMetrics">ì¡°íšŒ</button>
        </div>
      </div>
      
      <!-- ì§€í‘œ í† ê¸€ -->
      <div class="mt-3">
        <label class="form-label">í‘œì‹œí•  ì§€í‘œ</label>
        <div id="metricsToggle" class="d-flex flex-wrap gap-2"></div>
      </div>
    </div>
  </div>

  <!-- ë¡œë”© ìƒíƒœ -->
  <div id="loading" class="text-center py-5" style="display: none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
    </div>
    <p class="mt-2">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
  </div>

  <!-- KPI ì¹´ë“œ -->
  <div id="kpiCards" class="row mb-4" style="display: none;">
    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
  </div>

  <!-- ì°¨íŠ¸ ì˜ì—­ -->
  <div id="chartArea" class="row mb-4" style="display: none;">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">ì‹œê³„ì—´ ì°¨íŠ¸</h5>
        </div>
        <div class="card-body">
          <canvas id="metricsChart" width="400" height="150"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- í‘œ ë°ì´í„° -->
  <div id="tableArea" class="row" style="display: none;">
    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
  </div>

  <!-- ì—ëŸ¬ ë©”ì‹œì§€ -->
  <div id="errorMessage" class="alert alert-danger" style="display: none;">
    <h6>ì˜¤ë¥˜ ë°œìƒ</h6>
    <p id="errorText"></p>
  </div>
</div>

<!-- Chart.js with date adapter -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
// ì „ì—­ ë³€ìˆ˜
let currentChart = null;
let currentService = 'booker';
let availableMetrics = {};

// ì„œë¹„ìŠ¤ë³„ ì§€í‘œ ì •ì˜
const serviceMetrics = {
  booker: {
    success_rate: 'ì˜ˆì•½ ì„±ê³µë¥ ',
    overlap_rate: 'ì¤‘ë³µì‹œë„ìœ¨',
    occupancy: 'ì ìœ ìœ¨'
  },
  calendar: {
    dau: 'DAU',
    tab_share_my: 'My íƒ­ ë¹„ì¤‘',
    tab_share_vacation: 'Vacation íƒ­ ë¹„ì¤‘',
    tab_share_official: 'Official íƒ­ ë¹„ì¤‘'
  },
  reportit: {
    created: 'ì‹ ê·œ ì´ìŠˆ',
    resolved: 'í•´ê²°ëœ ì´ìŠˆ',
    resolve_rate: 'í•´ê²°ìœ¨',
    ttr_avg: 'í‰ê·  TTR(ë¶„)',
    ttr_p50: 'TTR P50(ë¶„)'
  },
  faq: {
    zero_rate: 'ê²€ìƒ‰ 0ê±´ ë¹„ìœ¨'
  },
  noonpick: {
    select_rate: 'ì„ íƒë¥ ',
    dup7: '7ì¼ ì¤‘ë³µë¥ '
  }
};

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
  initializeDateInputs();
  setupEventListeners();
  updateMetricsToggle();
  initializeChart();
  loadDefaultMetrics();
});

function initializeChart() {
  // ì°¨íŠ¸ ì˜ì—­ ì´ˆê¸°í™”
  const chartArea = document.getElementById('chartArea');
  chartArea.style.display = 'none';
  
  // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆë‹¤ë©´ íŒŒê´´
  if (currentChart) {
    currentChart.destroy();
    currentChart = null;
  }
}

function initializeDateInputs() {
  const now = new Date();
  const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
  
  document.getElementById('toDate').value = formatDateTimeLocal(now);
  document.getElementById('fromDate').value = formatDateTimeLocal(weekAgo);
}

function formatDateTimeLocal(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  
  return `${year}-${month}-${day}T${hours}:${minutes}`;
}

function setupEventListeners() {
  document.getElementById('serviceSelect').addEventListener('change', function() {
    currentService = this.value;
    updateMetricsToggle();
  });
  
  document.getElementById('loadMetrics').addEventListener('click', loadMetrics);
}

function updateMetricsToggle() {
  const metricsToggleDiv = document.getElementById('metricsToggle');
  metricsToggleDiv.innerHTML = '';
  
  const metrics = serviceMetrics[currentService] || {};
  
  Object.keys(metrics).forEach(metricKey => {
    const label = document.createElement('label');
    label.className = 'form-check-label me-3';
    label.innerHTML = `
      <input class="form-check-input me-1" type="checkbox" value="${metricKey}" checked>
      ${metrics[metricKey]}
    `;
    metricsToggleDiv.appendChild(label);
  });
}

function getSelectedMetrics() {
  const checkboxes = document.querySelectorAll('#metricsToggle input[type="checkbox"]:checked');
  return Array.from(checkboxes).map(cb => cb.value);
}

function loadDefaultMetrics() {
  loadMetrics();
}

async function loadMetrics() {
  const service = document.getElementById('serviceSelect').value;
  const fromDate = document.getElementById('fromDate').value;
  const toDate = document.getElementById('toDate').value;
  const bucketType = document.getElementById('bucketType').value;
  const selectedMetrics = getSelectedMetrics();
  
  // ë¡œë”© ìƒíƒœ í‘œì‹œ
  showLoading();
  hideError();
  
  try {
    const params = new URLSearchParams({
      service: service,
      from: fromDate.replace('T', ' '),
      to: toDate.replace('T', ' '),
      include: selectedMetrics.join(',')
    });
    
    if (bucketType !== 'auto') {
      params.append('bucket', bucketType);
    }
    
    const response = await fetch(`/admin/api/metrics?${params}`);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    
    if (data.error) {
      throw new Error(data.error);
    }
    
    renderMetrics(data);
    
  } catch (error) {
    console.error('Error loading metrics:', error);
    showError(error.message);
  } finally {
    hideLoading();
  }
}

function renderMetrics(data) {
  renderKPICards(data.kpis);
  renderChart(data.series, data.range.bucket);
  renderTables(data.tables);
  updateLastUpdated(data.last_updated_kst);
}

function renderKPICards(kpis) {
  const container = document.getElementById('kpiCards');
  container.innerHTML = '';
  
  Object.keys(kpis).forEach(metricKey => {
    const metric = kpis[metricKey];
    const metricName = serviceMetrics[currentService][metricKey] || metricKey;
    
    const col = document.createElement('div');
    col.className = 'col-md-3 mb-3';
    
    let displayValue = metric.value;
    if (metricKey.includes('rate') || metricKey.includes('dup')) {
      displayValue = (metric.value * 100).toFixed(1) + '%';
    } else if (Number.isInteger(metric.value)) {
      displayValue = metric.value.toLocaleString();
    } else {
      displayValue = metric.value.toFixed(1);
    }
    
    col.innerHTML = `
      <div class="card">
        <div class="card-body text-center">
          <h5 class="card-title text-muted">${metricName}</h5>
          <h2 class="card-text text-primary">${displayValue}</h2>
        </div>
      </div>
    `;
    
    container.appendChild(col);
  });
  
  container.style.display = 'flex';
}

function renderChart(series, bucketType) {
  const canvas = document.getElementById('metricsChart');
  
  // ê¸°ì¡´ ì°¨íŠ¸ íŒŒê´´
  if (currentChart) {
    currentChart.destroy();
    currentChart = null;
  }
  
  // Canvas ì´ˆê¸°í™”
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  const datasets = [];
  const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6c757d'];
  let colorIndex = 0;
  
  Object.keys(series).forEach(metricKey => {
    const metricName = serviceMetrics[currentService][metricKey] || metricKey;
    const data = series[metricKey];
    
    datasets.push({
      label: metricName,
      data: data.map(point => ({ x: point[0], y: point[1] })),
      borderColor: colors[colorIndex % colors.length],
      backgroundColor: colors[colorIndex % colors.length] + '20',
      fill: false,
      tension: 0.1
    });
    
    colorIndex++;
  });
  
  // Chart.js ì„¤ì •
  const chartConfig = {
    type: 'line',
    data: { datasets: datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          type: 'time',
          time: {
            unit: bucketType === 'hour' ? 'hour' : 'day'
          },
          title: {
            display: true,
            text: bucketType === 'hour' ? 'ì‹œê°„' : 'ë‚ ì§œ'
          },
          ticks: {
            maxTicksLimit: 10
          }
        },
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'ê°’'
          }
        }
      },
      plugins: {
        legend: {
          display: true,
          position: 'top'
        }
      }
    }
  };
  
  // ì°¨íŠ¸ ìƒì„±
  try {
    currentChart = new Chart(ctx, chartConfig);
    document.getElementById('chartArea').style.display = 'block';
  } catch (error) {
    console.error('Chart creation error:', error);
    console.log('Falling back to category axis...');
    
    // Fallback: ì‹œê°„ ì¶• ëŒ€ì‹  ì¹´í…Œê³ ë¦¬ ì¶• ì‚¬ìš©
    chartConfig.options.scales.x = {
      type: 'category',
      title: {
        display: true,
        text: bucketType === 'hour' ? 'ì‹œê°„' : 'ë‚ ì§œ'
      },
      ticks: {
        maxTicksLimit: 10
      }
    };
    
    // ë°ì´í„°ë¥¼ ì¹´í…Œê³ ë¦¬ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    chartConfig.data.datasets.forEach(dataset => {
      dataset.data = dataset.data.map(point => ({
        x: point.x, // ë‚ ì§œ ë¬¸ìì—´ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        y: point.y
      }));
    });
    
    try {
      currentChart = new Chart(ctx, chartConfig);
      document.getElementById('chartArea').style.display = 'block';
    } catch (fallbackError) {
      console.error('Fallback chart creation error:', fallbackError);
      showError('ì°¨íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
  }
}

function renderTables(tables) {
  const container = document.getElementById('tableArea');
  container.innerHTML = '';
  
  if (!tables || Object.keys(tables).length === 0) {
    container.style.display = 'none';
    return;
  }
  
  Object.keys(tables).forEach(tableName => {
    const tableData = tables[tableName];
    
    const col = document.createElement('div');
    col.className = 'col-md-6 mb-3';
    
    let tableTitle = tableName;
    if (tableName === 'top_docs') tableTitle = 'Top ë¬¸ì„œ';
    else if (tableName === 'zero_queries') tableTitle = '0ê±´ ê²€ìƒ‰ ì¿¼ë¦¬';
    else if (tableName === 'top_menus') tableTitle = 'Top ë©”ë‰´';
    
    let tableHtml = `
      <div class="card">
        <div class="card-header">
          <h6 class="card-title mb-0">${tableTitle}</h6>
        </div>
        <div class="card-body">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>í•­ëª©</th>
                <th class="text-end">ìˆ˜ëŸ‰</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    if (Array.isArray(tableData) && tableData.length > 0) {
      tableData.forEach(([item, count]) => {
        tableHtml += `
          <tr>
            <td>${item}</td>
            <td class="text-end">${count.toLocaleString()}</td>
          </tr>
        `;
      });
    } else {
      tableHtml += '<tr><td colspan="2" class="text-center text-muted">ë°ì´í„° ì—†ìŒ</td></tr>';
    }
    
    tableHtml += `
            </tbody>
          </table>
        </div>
      </div>
    `;
    
    col.innerHTML = tableHtml;
    container.appendChild(col);
  });
  
  container.style.display = 'flex';
}

function updateLastUpdated(timestamp) {
  document.getElementById('lastUpdated').textContent = `ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${timestamp}`;
}

function showLoading() {
  document.getElementById('loading').style.display = 'block';
  document.getElementById('kpiCards').style.display = 'none';
  document.getElementById('chartArea').style.display = 'none';
  document.getElementById('tableArea').style.display = 'none';
}

function hideLoading() {
  document.getElementById('loading').style.display = 'none';
}

function showError(message) {
  document.getElementById('errorText').textContent = message;
  document.getElementById('errorMessage').style.display = 'block';
  document.getElementById('kpiCards').style.display = 'none';
  document.getElementById('chartArea').style.display = 'none';
  document.getElementById('tableArea').style.display = 'none';
}

function hideError() {
  document.getElementById('errorMessage').style.display = 'none';
}
</script>
{% endblock %}
