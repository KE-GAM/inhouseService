{% extends "sidebar_base.html" %}

{% block content %}
<div class="container-fluid h-100">
  <div class="row h-100">
    <!-- í•„í„° íŒ¨ë„ -->
    <div class="col-md-4 col-lg-3 p-3 border-end">
      <h4 class="mb-3">ğŸ½ï¸ {{ t('services.noonpick') }}</h4>
      <p class="text-muted small mb-4">{{ t('noonpick.subtitle') }}</p>
      
      <form id="filterForm">
        <!-- ì˜¤í”¼ìŠ¤ ì„ íƒ -->
        <div class="mb-3">
          <label class="form-label fw-bold">{{ t('noonpick.office') }}</label>
          <select class="form-select" id="office" name="office">
            {% for office in offices %}
            <option value="{{ office.code }}" {% if office.code == 'seoul' %}selected{% endif %}>
              {{ office.name }}
            </option>
            {% endfor %}
          </select>
        </div>

        <!-- ë°˜ê²½ ì„ íƒ -->
        <div class="mb-3">
          <label class="form-label fw-bold">{{ t('noonpick.radius') }}</label>
          <div class="btn-group w-100" role="group">
            <input type="radio" class="btn-check" name="radius" id="radius100" value="100">
            <label class="btn btn-outline-primary" for="radius100">100m</label>
            
            <input type="radio" class="btn-check" name="radius" id="radius200" value="200">
            <label class="btn btn-outline-primary" for="radius200">200m</label>
            
            <input type="radio" class="btn-check" name="radius" id="radius300" value="300" checked>
            <label class="btn btn-outline-primary" for="radius300">300m</label>
            
            <input type="radio" class="btn-check" name="radius" id="radius500" value="500">
            <label class="btn btn-outline-primary" for="radius500">500m</label>
          </div>
        </div>

        <!-- ì¹´í…Œê³ ë¦¬ ì„ íƒ -->
        <div class="mb-3">
          <label class="form-label fw-bold">{{ t('noonpick.category') }} <small class="text-muted">({{ t('noonpick.multiple_selection') }})</small></label>
          <div class="row g-2">
            <div class="col-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="KOREAN" id="catKorean">
                <label class="form-check-label" for="catKorean">{{ t('noonpick.korean') }}</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="CHINESE" id="catChinese">
                <label class="form-check-label" for="catChinese">{{ t('noonpick.chinese') }}</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="JAPANESE" id="catJapanese">
                <label class="form-check-label" for="catJapanese">{{ t('noonpick.japanese') }}</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="WESTERN" id="catWestern">
                <label class="form-check-label" for="catWestern">{{ t('noonpick.western') }}</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="MEAT" id="catMeat">
                <label class="form-check-label" for="catMeat">{{ t('noonpick.meat') }}</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="SOUP" id="catSoup">
                <label class="form-check-label" for="catSoup">{{ t('noonpick.soup') }}</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="NOODLE" id="catNoodle">
                <label class="form-check-label" for="catNoodle">{{ t('noonpick.noodle') }}</label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="RICE" id="catRice">
                <label class="form-check-label" for="catRice">{{ t('noonpick.rice') }}</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="CAFE" id="catCafe">
                <label class="form-check-label" for="catCafe">{{ t('noonpick.cafe') }}</label>
              </div>
            </div>
          </div>
        </div>

        <!-- ë‚ ì”¨ ì˜í–¥ (í–¥í›„ êµ¬í˜„) -->
        <div class="mb-4">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="weatherToggle" disabled>
            <label class="form-check-label text-muted" for="weatherToggle">
              ë‚ ì”¨ ì˜í–¥ ë°˜ì˜ <small>(ì¤€ë¹„ì¤‘)</small>
            </label>
          </div>
        </div>

        <!-- ì¶”ì²œ ë²„íŠ¼ -->
        <button type="button" class="btn btn-primary w-100 py-2 mb-3" id="recommendBtn">
          ğŸ¯ {{ t('noonpick.recommend') }}
        </button>

        <!-- ë‹¤ì‹œ ëŒë¦¬ê¸° ë²„íŠ¼ -->
        <button type="button" class="btn btn-outline-secondary w-100" id="reshuffleBtn" style="display: none;">
          ğŸ² {{ t('noonpick.reshuffle') }}
        </button>
      </form>
    </div>

    <!-- ì§€ë„ ë° ê²°ê³¼ íŒ¨ë„ -->
    <div class="col-md-8 col-lg-9 p-0 d-flex flex-column">
      <!-- ì§€ë„ -->
      <div id="map" style="height: 50%; min-height: 300px;"></div>
      
      <!-- ê²°ê³¼ ì¹´ë“œ -->
      <div class="flex-fill p-3 overflow-auto" id="resultsPanel">
        <div id="loadingSpinner" class="text-center py-5" style="display: none;">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2 text-muted">ë§›ìˆëŠ” ê³³ì„ ì°¾ê³  ìˆì–´ìš”...</p>
        </div>

        <div id="welcomeMessage" class="text-center py-5 text-muted">
          <h5>ğŸ½ï¸ {{ t('noonpick.welcome_title') }}</h5>
          <p>{{ t('noonpick.welcome_message') }}</p>
        </div>

        <div id="resultsContainer" style="display: none;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Google Maps API -->
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_key }}&callback=initMap"></script>

<script>
let map;
let markers = [];
let excludedIds = [];
let hasGoogleMap = {{ 'true' if google_maps_key and google_maps_key != 'None' and google_maps_key.strip() else 'false' }};

// ë””ë²„ê¹… ì •ë³´
console.log('google_maps_key:', '{{ google_maps_key }}');
console.log('hasGoogleMap:', hasGoogleMap);

// ì§€ë„ ì´ˆê¸°í™”
function initMap() {
  const container = document.getElementById('map');
  
  if (!hasGoogleMap) {
    // API í‚¤ê°€ ì—†ì„ ë•Œ ëŒ€ì²´ UI í‘œì‹œ
    container.innerHTML = `
      <div class="d-flex align-items-center justify-content-center h-100 bg-light">
        <div class="text-center text-muted">
          <h5>ğŸ—ºï¸ ì§€ë„ ì„œë¹„ìŠ¤</h5>
          <p class="mb-0">Google Maps API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
          <small>API í‚¤ë¥¼ ì„¤ì •í•˜ë©´ ì§€ë„ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
        </div>
      </div>
    `;
    return;
  }
  
  // Google Maps ì´ˆê¸°í™”
  try {
    const options = {
      center: { lat: 37.5093056, lng: 127.0610611 }, // ì„œìš¸ ì˜¤í”¼ìŠ¤ ì •í™•í•œ ì¢Œí‘œ
      zoom: 15
    };
    map = new google.maps.Map(container, options);
    console.log('Google Maps ì´ˆê¸°í™” ì™„ë£Œ');
  } catch (error) {
    console.error('Google Maps ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
    container.innerHTML = `
      <div class="d-flex align-items-center justify-content-center h-100 bg-light">
        <div class="text-center text-muted">
          <h5>ğŸ—ºï¸ ì§€ë„ ì„œë¹„ìŠ¤</h5>
          <p class="mb-0">ì§€ë„ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
          <small>API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</small>
        </div>
      </div>
    `;
  }
}

// ë§ˆì»¤ ì œê±°
function clearMarkers() {
  if (!hasGoogleMap || !map) return;
  markers.forEach(marker => marker.setMap(null));
  markers = [];
}

// ë§ˆì»¤ ì¶”ê°€
function addMarker(lat, lng, title, isPrimary = false) {
  if (!hasGoogleMap || !map || typeof google === 'undefined' || !google.maps) return;
  
  const position = { lat: lat, lng: lng };
  const marker = new google.maps.Marker({
    position: position,
    title: title,
    map: map,
    icon: isPrimary ? {
      url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
      scaledSize: new google.maps.Size(30, 30)
    } : {
      url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
      scaledSize: new google.maps.Size(25, 25)
    }
  });
  
  markers.push(marker);
  
  // ì¸í¬ìœˆë„ìš°
  const infowindow = new google.maps.InfoWindow({
    content: `<div style="padding:5px;font-size:12px;text-align:center;">${title}</div>`
  });
  
  marker.addListener('mouseover', function() {
    infowindow.open(map, marker);
  });
  
  marker.addListener('mouseout', function() {
    infowindow.close();
  });
  
  return marker;
}

// í•„í„° ë°ì´í„° ìˆ˜ì§‘
function getFilterData() {
  const office = document.getElementById('office').value;
  const radius = document.querySelector('input[name="radius"]:checked').value;
  const categories = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
    .map(cb => cb.value)
    .filter(val => val !== 'on'); // ë‚ ì”¨ í† ê¸€ ì œì™¸
  
  return { office, radius, categories };
}

// ì¹´í…Œê³ ë¦¬ ë°°ì§€ ìƒì„±
function getCategoryBadge(categories) {
  if (!categories || categories.length === 0) return '';
  
  const categoryNames = {
    'KOREAN': 'í•œì‹', 'CHINESE': 'ì¤‘ì‹', 'JAPANESE': 'ì¼ì‹', 'WESTERN': 'ì–‘ì‹',
    'MEAT': 'ê³ ê¸°', 'SOUP': 'êµ­Â·íƒ•', 'NOODLE': 'ë©´', 'RICE': 'ë®ë°¥', 'CAFE': 'ì¹´í˜'
  };
  
  return categories.slice(0, 2).map(cat => 
    `<span class="badge bg-secondary me-1">${categoryNames[cat] || cat}</span>`
  ).join('');
}

// ì´ë¯¸ì§€ HTML ìƒì„± í•¨ìˆ˜
function createImageHtml(placeImage, placeName) {
  if (placeImage) {
    return `<img src="${placeImage}" class="img-fluid rounded" alt="${placeName}" style="height:150px;object-fit:cover;width:100%;" onerror="handleImageError(this)">`;
  } else {
    return `<div class="bg-light rounded d-flex align-items-center justify-content-center" style="height:150px;">
              <span class="text-muted">ğŸ½ï¸</span>
            </div>`;
  }
}

// ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì²˜ë¦¬ í•¨ìˆ˜
function handleImageError(imgElement) {
  imgElement.parentElement.innerHTML = '<div class="bg-light rounded d-flex align-items-center justify-content-center" style="height:150px;"><span class="text-muted">ğŸ½ï¸</span></div>';
}

// ê²°ê³¼ ì¹´ë“œ ìƒì„±
function createPlaceCard(place, isPrimary = false) {
  const ogTitle = place.og?.title || place.name;
  const ogDesc = place.og?.description || '';
  // ì‚¬ì§„ ìš°ì„ ìˆœìœ„: ìŒì‹ì  ì‚¬ì§„ > OG ì´ë¯¸ì§€ > ê¸°ë³¸ ì•„ì´ì½˜
  const placeImage = place.photo_url || place.og?.image || '';
  
  const categories = JSON.parse(place.big_categories || '[]');
  const categoryBadges = getCategoryBadge(categories);
  
  const cardClass = isPrimary ? 'border-primary' : 'border-light';
  const headerClass = isPrimary ? 'bg-primary text-white' : 'bg-light';
  const headerText = isPrimary ? 'ğŸ¯ ì¶”ì²œ ë§›ì§‘' : 'ğŸ“ ëŒ€ì•ˆ ë§›ì§‘';
  
  return `
    <div class="card mb-3 ${cardClass}">
      <div class="card-header ${headerClass} py-2">
        <small class="fw-bold">${headerText}</small>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            ${createImageHtml(placeImage, place.name)}
          </div>
          <div class="col-md-9">
            <h6 class="card-title mb-1">${ogTitle}</h6>
            ${ogDesc ? `<p class="card-text small text-muted mb-2">${ogDesc.substring(0, 100)}${ogDesc.length > 100 ? '...' : ''}</p>` : ''}
            <p class="card-text small mb-2">
              ğŸ“ ${place.address || place.road_address || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ'}<br>
              ğŸ“ ${place.distance_m}m Â· ${categoryBadges}
              ${place.rating > 0 ? `<br>â­ ${place.rating.toFixed(1)}ì ` : ''}
              ${place.phone ? `<br>ğŸ“ ${place.phone}` : ''}
            </p>
            <div class="d-flex gap-2">
              <a href="${place.google_place_url}" target="_blank" class="btn btn-outline-primary btn-sm">
                ğŸ” ê°€ê²Œ ìƒì„¸ë³´ê¸°
              </a>
              <button class="btn btn-success btn-sm" onclick="recordVisit('${place.id}')">
                âœ… ì„ íƒ
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

// ì ì‹¬ ì¶”ì²œ ìš”ì²­
async function getRecommendation() {
  const { office, radius, categories } = getFilterData();
  
  document.getElementById('loadingSpinner').style.display = 'block';
  document.getElementById('welcomeMessage').style.display = 'none';
  document.getElementById('resultsContainer').style.display = 'none';
  
  try {
    const params = new URLSearchParams({
      office: office,
      radius: radius,
      cats: categories.join(','),
      exclude: excludedIds.join(',')
    });
    
    const response = await fetch(`/api/lunch/reco?${params}`);
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error || 'ì¶”ì²œ ìš”ì²­ ì‹¤íŒ¨');
    }
    
    // ì§€ë„ ì—…ë°ì´íŠ¸
    clearMarkers();
    if (data.primary && hasGoogleMap && map) {
      addMarker(data.primary.lat, data.primary.lng, data.primary.name, true);
      if (typeof google !== 'undefined' && google.maps) {
        map.setCenter({ lat: data.primary.lat, lng: data.primary.lng });
      }
    }
    
    data.alternatives?.forEach(place => {
      if (hasGoogleMap && map) {
        addMarker(place.lat, place.lng, place.name, false);
      }
    });
    
    // ê²°ê³¼ ì¹´ë“œ í‘œì‹œ
    let html = createPlaceCard(data.primary, true);
    data.alternatives?.forEach(place => {
      html += createPlaceCard(place, false);
    });
    
    document.getElementById('resultsContainer').innerHTML = html;
    document.getElementById('resultsContainer').style.display = 'block';
    document.getElementById('reshuffleBtn').style.display = 'block';
    
    // ì œì™¸ ëª©ë¡ ì—…ë°ì´íŠ¸
    excludedIds = data.excluded_suggestion || [];
    
  } catch (error) {
    alert('ì¶”ì²œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
  } finally {
    document.getElementById('loadingSpinner').style.display = 'none';
  }
}

// ë°©ë¬¸ ê¸°ë¡
async function recordVisit(placeId) {
  try {
    const response = await fetch('/api/lunch/visit', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        place_id: placeId,
        user_id: 1
      })
    });
    
    if (response.ok) {
      alert('ì„ íƒì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ë§›ìˆê²Œ ë“œì„¸ìš” ğŸ½ï¸');
    }
  } catch (error) {
    console.error('ë°©ë¬¸ ê¸°ë¡ ì‹¤íŒ¨:', error);
  }
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
document.addEventListener('DOMContentLoaded', function() {
  initMap();
  
  document.getElementById('recommendBtn').addEventListener('click', getRecommendation);
  document.getElementById('reshuffleBtn').addEventListener('click', getRecommendation);
});
</script>

<style>
.card {
  transition: transform 0.2s;
}

.card:hover {
  transform: translateY(-2px);
}

.form-check-input:checked {
  background-color: #0d6efd;
  border-color: #0d6efd;
}

.btn-group .btn-check:checked + .btn {
  background-color: #0d6efd;
  border-color: #0d6efd;
  color: white;
}

/* ë‹¤í¬ëª¨ë“œ ìŠ¤íƒ€ì¼ */
[data-theme="dark"] .form-select {
  background-color: #181a1b !important;
  border-color: #30363d !important;
  color: #f0f6fc !important;
}

[data-theme="dark"] .form-select:focus {
  background-color: #181a1b !important;
  border-color: #0d6efd !important;
  color: #f0f6fc !important;
  box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
}

[data-theme="dark"] .form-check-input {
  background-color: #181a1b !important;
  border-color: #30363d !important;
}

[data-theme="dark"] .form-check-input:checked {
  background-color: #0d6efd !important;
  border-color: #0d6efd !important;
}

[data-theme="dark"] .form-check-label {
  color: #f0f6fc !important;
}

[data-theme="dark"] .btn-outline-primary {
  color: #0d6efd !important;
  border-color: #0d6efd !important;
}

[data-theme="dark"] .btn-outline-primary:hover {
  background-color: #0d6efd !important;
  border-color: #0d6efd !important;
  color: white !important;
}

[data-theme="dark"] .btn-outline-secondary {
  color: #6c757d !important;
  border-color: #6c757d !important;
}

[data-theme="dark"] .btn-outline-secondary:hover {
  background-color: #6c757d !important;
  border-color: #6c757d !important;
  color: white !important;
}
</style>
{% endblock %}
